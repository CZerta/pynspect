#-------------------------------------------------------------------------------
# This file is part of Pynspect package.
#
# Copyright (C) since 2016 CESNET, z.s.p.o (http://www.ces.net/)
# Copyright (C) since 2016 Jan Mach <honza.mach.ml@gmail.com>
# Use of this source is governed by the MIT license, see LICENSE file.
#-------------------------------------------------------------------------------

DOCDIR = doc
DIST_SIZE:=$(shell ls dist | wc -l)

all: archive bdist deploy

build: archive bdist

buildbot: bdist

help:
	$(info List of possible make targets:)
	$(info   )
	$(info   * all:     archive previous packages, build new distribution and deploy to PyPI [default])
	$(info   * build:   archive previous packages and build new distribution)
	$(info   * test:    run unit tests)
	$(info   * archive: archive previous packages)
	$(info   * bdist:   build new distribution)
	$(info   * install: install distribution on local machine)
	$(info   * deploy:  deploy to PyPI)
	$(info   )

# Perform unit tests
test: FORCE
	$(info Testing source code)
	nosetests

# Move old distribution files to archive directory
archive: FORCE
	$(info Checking if dist archivation is needed)
	@if ! [ `ls dist/pynspect* | wc -l` = "0" ]; then\
		echo "Moving old distribution files to local archive";\
		mv -f dist/pynspect* archive;\
	fi

# Build various Python package distributions
bdist: FORCE
	$(info Building distributions)

	# Build Python3 only wheel and egg.
	python3 setup.py sdist bdist_wheel

	# Or build universal wheel and egg.
	#python3 setup.py sdist bdist_wheel --universal

# Perform installation from local files for Python 3
install: FORCE
	$(info Local installation)
	pip3 install dist/pynspect*.whl --upgrade

# Deploy latest packages to PyPI
deploy: FORCE
	$(info PyPI deployment)

	# Secure upload with Twine
	twine upload dist/pynspect*

# Empty rule as dependency wil force make to always perform target
# Source: https://www.gnu.org/software/make/manual/html_node/Force-Targets.html
FORCE:
